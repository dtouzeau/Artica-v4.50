<?phpinclude_once(dirname(__FILE__)."/ressources/class.template-admin.inc");if(!isset($GLOBALS["CLASS_SOCKETS"])){if(!class_exists("sockets")){include_once("/usr/share/artica-postfix/ressources/class.sockets.inc");}$GLOBALS["CLASS_SOCKETS"]=new sockets();}include_once(dirname(__FILE__)."/ressources/class.ip2host.inc");if(isset($_GET["verbose"])){$GLOBALS["VERBOSE"]=true;ini_set('display_errors', 1);ini_set('error_reporting', E_ALL);ini_set('error_prepend_string',null);ini_set('error_append_string',null);}if(isset($_POST["recategorize"])){exit();}if(isset($_GET["query"])){query();exit;}if(isset($_GET["query-js"])){query_js();exit;}if(isset($_GET["query-popup"])){query_popup();exit;}if(isset($_POST["FROM"])){query_save();exit;}if(isset($_GET["categories"])){categories_table();exit;}if(isset($_GET["search-categories"])){categories_table_build();;exit;}if(isset($_GET["categories-list-js"])){category_list_js();exit;}if(isset($_GET["categories-list"])){category_list();exit;}if(isset($_GET["members-form"])){members_form();exit;}if(isset($_GET["search-members"])){members_search();exit;}if(isset($_GET["sites-form"])){sites_form();exit;}if(isset($_GET["sites-search"])){sites_search();exit;}if(isset($_GET["users-from-cat-js"])){users_category_js();exit;}if(isset($_GET["users-from-cat-list"])){users_category_list();exit;}if(isset($_GET["members-from-cat-js"])){members_category_js();exit;}if(isset($_GET["members-from-cat-list"])){members_category_list();exit;}if(isset($_GET["ipaddr-from-cat-js"])){ipaddr_category_js();exit;}if(isset($_GET["ipaddr-from-cat-list"])){ipaddr_category_list();exit;}if(isset($_GET["recategorize-js"])){recategorize_js();exit;}tabs();function query_js(){    $tpl=new template_admin();    $page=CurrentPageName();    $tpl->js_dialog1("{build_query}","$page?query-popup=yes",650);}function recategorize_js(){    $catz=new mysql_catz();    $tpl=new template_admin();    $page=CurrentPageName();    $category_id=intval($_GET["recategorize-js"]);    $ARRAY["PROGRESS_FILE"]=PROGRESS_DIR."/recategorize-$category_id.progress";    $ARRAY["LOG_FILE"]=PROGRESS_DIR."/recategorize-$category_id.log";    $ARRAY["CMD"]="statscom.php?recategorize-single=$category_id";    $ARRAY["TITLE"]="{rescan_database}";    $ARRAY["AFTER"]="dialogInstance2.close();Loadjs('$page?categories-list-js=$category_id');";    $prgress=base64_encode(serialize($ARRAY));    $jsafter="Loadjs('fw.progress.php?content=$prgress&mainid=recategorize-$category_id')";    $category_name=$catz->CategoryIntToStr($category_id);    $tpl->js_confirm_execute("{rescan_database}: $category_name<hr>{recategorize_category_ask}","recategorize",$category_id,$jsafter);}function category_list_js(){    $tpl=new template_admin();    $page=CurrentPageName();    $catz=new mysql_catz();    $category_id=$_GET["categories-list-js"];    $tpl->js_dialog2($catz->CategoryIntToStr($category_id),"$page?categories-list=$category_id",1050);}function users_category_js(){    $tpl=new template_admin();    $page=CurrentPageName();    $catz=new mysql_catz();    $category_id=$_GET["users-from-cat-js"];    $tpl->js_dialog2($catz->CategoryIntToStr($category_id).": {members}/{MAC}/{ipaddr}","$page?users-from-cat-list=$category_id",1050);}function members_category_js(){    $tpl=new template_admin();    $page=CurrentPageName();    $catz=new mysql_catz();    $category_id=$_GET["members-from-cat-js"];    $tpl->js_dialog2($catz->CategoryIntToStr($category_id).": {members}","$page?members-from-cat-list=$category_id",1050);}function ipaddr_category_js(){    $tpl=new template_admin();    $page=CurrentPageName();    $catz=new mysql_catz();    $category_id=$_GET["ipaddr-from-cat-js"];    $tpl->js_dialog2($catz->CategoryIntToStr($category_id).": {ipaddr}","$page?ipaddr-from-cat-list=$category_id",1050);}function sites_form(){    $tpl=new template_admin();    $page=CurrentPageName();    echo $tpl->search_block($page,null,null,null,"&sites-search=yes");}function members_form(){    $tpl=new template_admin();    $page=CurrentPageName();    echo $tpl->search_block($page,null,null,null,"&search-members=yes");}function categories_table(){    $tpl=new template_admin();    $page=CurrentPageName();    $q=new postgres_sql();    return categories_table_build();    echo $tpl->search_block($page,null,null,null,"&search-categories=yes");}function sites_search(){    $tpl=new template_admin();    $page=CurrentPageName();    $q=new postgres_sql();    $t=time();    $TRCLASS=null;    $html[]="    <div class='row border-bottom white-bg dashboard-header'><table id='table-$t' class=\"footable table table-stripped\"     data-page-size=\"100\" data-paging=\"true\">";    $html[]="<thead>";    $html[]="<tr>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{familysite}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{size}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{hits}</th>";    $html[]="</tr>";    $html[]="</thead>";    $html[]="<tbody>";    //hitstot	sizetot    $search=$_GET["search"];    if($search<>null){        $search=str_replace("*","%",$search);        $search=" WHERE (familysite LIKE '$search')";    }    $td1=$tpl->table_td1prc_Left();    $tdfree=$tpl->table_tdfree();    $sql="SELECT familysite, SUM(hitstot) as hits, SUM(sizetot) as size FROM statscom_websites{$search} GROUP by familysite ORDER by size DESC LIMIT 500";    $results=$q->QUERY_SQL($sql);    if(!$q->ok){echo $tpl->div_error($q->mysql_error);}    while ($ligne = pg_fetch_assoc($results)) {        if ($TRCLASS == "footable-odd ") {            $TRCLASS = null;        } else {            $TRCLASS = "footable-odd ";        }        $hits=$tpl->FormatNumber($ligne["hits"]);        $size=FormatBytes($ligne["size"]/1024);        $familysite=$ligne["familysite"];        $html[]="<tr style='vertical-align:middle' class='$TRCLASS'>";        $html[]="<td><strong>$familysite</strong></td>";        $html[]="<td $td1>$size</td>";        $html[]="<td $td1>$hits</td>";        $html[]="</tr>";    }    $html[]="</tbody>";    $html[]="<tfoot>";    $html[]="<tr>";    $html[]="<td colspan='3'>";    $html[]="<ul class='pagination pull-right'></ul>";    $html[]="</td>";    $html[]="</tr>";    $html[]="</tfoot>";    $html[]="</table>";    $html[]="</div><script> NoSpinner();\n".@implode("\n",$tpl->ICON_SCRIPTS)."$(document).ready(function() { $('#table-$t').footable({ \"filtering\": { \"enabled\": true }, \"sorting\": { \"enabled\": true },\"paging\": { \"size\": {$GLOBALS["FOOTABLE_PSIZE"]} } } ) }); </script>";    echo $tpl->_ENGINE_parse_body(@implode("\n", $html));}function members_search(){    $tpl=new template_admin();    $page=CurrentPageName();    $q=new postgres_sql();    $t=time();    $hideMacs=intval($GLOBALS["CLASS_SOCKETS"]->GET_INFO('statscomHideMacs'));    $hideUnkownMembers=intval($GLOBALS["CLASS_SOCKETS"]->GET_INFO('statscomHideUnkownMembers'));    $TRCLASS=null;    $html[]="    <div class='row border-bottom white-bg dashboard-header'><table id='table-$t' class=\"footable table table-stripped\"     data-page-size=\"100\" data-paging=\"true\">";    $html[]="<thead>";    $html[]="<tr>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{username}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{ipaddr}</th>";    if($hideMacs==0) {        $html[] = "<th data-sortable=true class='text-capitalize' data-type='text'>{mac}</th>";    }    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{size}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{hits}</th>";    $html[]="</tr>";    $html[]="</thead>";    $html[]="<tbody>";    //hitstot	sizetot    $search=$_GET["search"];    if($search<>null){        $search=str_replace("*","%",$search);        $search = " WHERE (username LIKE '$search') OR (mac::text LIKE::text '$search') OR (ipaddr::text LIKE '$search')";    }    $td1=$tpl->table_td1prc_Left();    $tdfree=$tpl->table_tdfree();    $sql="SELECT username,	ipaddr,mac, SUM(hits) as hits, SUM(size) as size FROM statscom_husers {$search} GROUP by username,ipaddr,mac ORDER by size DESC LIMIT 500";    $results=$q->QUERY_SQL($sql);    if(!$q->ok){echo $tpl->div_error($q->mysql_error);}    while ($ligne = pg_fetch_assoc($results)) {        if ($TRCLASS == "footable-odd ") {            $TRCLASS = null;        } else {            $TRCLASS = "footable-odd ";        }        $hits=$tpl->FormatNumber($ligne["hits"]);        $size=FormatBytes($ligne["size"]/1024);        $username=$ligne["username"];        $ipaddr=$ligne["ipaddr"];        $mac=$ligne["mac"];        if($username==null){            if($hideUnkownMembers==1){                $username=$ipaddr;            }            else{                $username="{unknown}";            }        }        $resolveIP2HOST=intval($GLOBALS["CLASS_SOCKETS"]->GET_INFO("resolveIP2HOST"));        if($resolveIP2HOST==1){            $host= new ip2host($ipaddr);            $ipaddr=$host->output;        }        $html[]="<tr style='vertical-align:middle' class='$TRCLASS'>";        $html[]="<td><strong>$username</strong></td>";        $html[]="<td $td1><strong>$ipaddr</strong></td>";        if($hideMacs==0) {            $html[] = "<td $td1><strong>$mac</strong></td>";        }        $html[]="<td $td1>$size</td>";        $html[]="<td $td1>$hits</td>";        $html[]="</tr>";    }    $html[]="</tbody>";    $html[]="<tfoot>";    $html[]="<tr>";    $html[]="<td colspan='5'>";    $html[]="<ul class='pagination pull-right'></ul>";    $html[]="</td>";    $html[]="</tr>";    $html[]="</tfoot>";    $html[]="</table>";    $html[]="</div><script> NoSpinner();\n".@implode("\n",$tpl->ICON_SCRIPTS)."$(document).ready(function() { $('#table-$t').footable({ \"filtering\": { \"enabled\": true }, \"sorting\": { \"enabled\": true },\"paging\": { \"size\": {$GLOBALS["FOOTABLE_PSIZE"]} } } ) }); </script>";    echo $tpl->_ENGINE_parse_body(@implode("\n", $html));}function ipaddr_category_list(){    $tpl=new template_admin();    $page=CurrentPageName();    $q=new postgres_sql();    $t=time();    $TRCLASS=null;    $category_id=$_GET["ipaddr-from-cat-list"];    $html[]="    <div class='row border-bottom white-bg dashboard-header'><table id='table-$t' class=\"footable table table-stripped\"     data-page-size=\"100\" data-paging=\"true\">";    $html[]="<thead>";    $html[]="<tr>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{ipaddr}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{size}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{hits}</th>";    $html[]="</tr>";    $html[]="</thead>";    $html[]="<tbody>";    $td1=$tpl->table_td1prc_Left();    $tdfree=$tpl->table_tdfree();    $catz=new mysql_catz();    $sqlA="SELECT statscom_days.ipaddr,SUM(statscom_days.hits) as hits,SUM(statscom_days.size) as size FROM statscom_days,statscom_websites WHERE statscom_days.siteid=statscom_websites.siteid AND statscom_websites.category=$category_id GROUP BY statscom_days.ipaddr ORDER BY size DESC";    $sql="SELECT ipaddr,SUM(hits) as hits,SUM(size) as size FROM ($sqlA) as t GROUP BY ipaddr ORDER BY size DESC LIMIT 500";    $results=$q->QUERY_SQL($sql);    if(!$q->ok){        echo $tpl->div_error($q->mysql_error);    }    while ($ligne = pg_fetch_assoc($results)) {        if ($TRCLASS == "footable-odd ") {            $TRCLASS = null;        } else {            $TRCLASS = "footable-odd ";        }        $u=array();        $hits=$tpl->FormatNumber($ligne["hits"]);        $size=FormatBytes($ligne["size"]/1024);        $username=trim($ligne["ipaddr"]);        if($username==null){$username="{unknown}";}        $cname=@implode(", ",$u);        $html[]="<tr style='vertical-align:middle' class='$TRCLASS'>";        $html[]="<td><strong><i class=\"fas fa-user\"></i>&nbsp;$username</strong></td>";        $html[]="<td $td1>$size</td>";        $html[]="<td $td1>$hits</td>";        $html[]="</tr>";    }    $html[]="</tbody>";    $html[]="<tfoot>";    $html[]="<tr>";    $html[]="<td colspan='8'>";    $html[]="<ul class='pagination pull-right'></ul>";    $html[]="</td>";    $html[]="</tr>";    $html[]="</tfoot>";    $html[]="</table>";    $html[]="</div><script> NoSpinner();\n".@implode("\n",$tpl->ICON_SCRIPTS)."$(document).ready(function() { $('#table-$t').footable({ \"filtering\": { \"enabled\": true }, \"sorting\": { \"enabled\": true },\"paging\": { \"size\": {$GLOBALS["FOOTABLE_PSIZE"]} } } ) }); </script>";    echo $tpl->_ENGINE_parse_body(@implode("\n", $html));}function members_category_list(){    $tpl=new template_admin();    $page=CurrentPageName();    $q=new postgres_sql();    $t=time();    $TRCLASS=null;    $category_id=$_GET["members-from-cat-list"];    $html[]="    <div class='row border-bottom white-bg dashboard-header'><table id='table-$t' class=\"footable table table-stripped\"     data-page-size=\"100\" data-paging=\"true\">";    $html[]="<thead>";    $html[]="<tr>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{members}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{size}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{hits}</th>";    $html[]="</tr>";    $html[]="</thead>";    $html[]="<tbody>";    $td1=$tpl->table_td1prc_Left();    $tdfree=$tpl->table_tdfree();    $catz=new mysql_catz();    $sqlA="SELECT statscom_days.username,SUM(statscom_days.hits) as hits,SUM(statscom_days.size) as size FROM statscom_days,statscom_websites WHERE statscom_days.siteid=statscom_websites.siteid AND statscom_websites.category=$category_id GROUP BY statscom_days.username ORDER BY size DESC";    $sql="SELECT username,SUM(hits) as hits,SUM(size) as size FROM ($sqlA) as t GROUP BY username ORDER BY size DESC LIMIT 500";    $results=$q->QUERY_SQL($sql);    if(!$q->ok){        echo $tpl->div_error($q->mysql_error);    }    while ($ligne = pg_fetch_assoc($results)) {        if ($TRCLASS == "footable-odd ") {            $TRCLASS = null;        } else {            $TRCLASS = "footable-odd ";        }        $u=array();        $hits=$tpl->FormatNumber($ligne["hits"]);        $size=FormatBytes($ligne["size"]/1024);        $username=trim($ligne["username"]);        if($username==null){$username="{unknown}";}        $cname=@implode(", ",$u);        $html[]="<tr style='vertical-align:middle' class='$TRCLASS'>";        $html[]="<td><strong><i class=\"fas fa-user\"></i>&nbsp;$username</strong></td>";        $html[]="<td $td1>$size</td>";        $html[]="<td $td1>$hits</td>";        $html[]="</tr>";    }    $html[]="</tbody>";    $html[]="<tfoot>";    $html[]="<tr>";    $html[]="<td colspan='8'>";    $html[]="<ul class='pagination pull-right'></ul>";    $html[]="</td>";    $html[]="</tr>";    $html[]="</tfoot>";    $html[]="</table>";    $html[]="</div><script> NoSpinner();\n".@implode("\n",$tpl->ICON_SCRIPTS)."$(document).ready(function() { $('#table-$t').footable({ \"filtering\": { \"enabled\": true }, \"sorting\": { \"enabled\": true },\"paging\": { \"size\": {$GLOBALS["FOOTABLE_PSIZE"]} } } ) }); </script>";    echo $tpl->_ENGINE_parse_body(@implode("\n", $html));}function users_category_list(){    $tpl=new template_admin();    $page=CurrentPageName();    $q=new postgres_sql();    $t=time();    $TRCLASS=null;    $category_id=$_GET["users-from-cat-list"];    $html[]="    <div class='row border-bottom white-bg dashboard-header'><table id='table-$t' class=\"footable table table-stripped\"     data-page-size=\"100\" data-paging=\"true\">";    $html[]="<thead>";    $html[]="<tr>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{members}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{size}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{hits}</th>";    $html[]="</tr>";    $html[]="</thead>";    $html[]="<tbody>";    $td1=$tpl->table_td1prc_Left();    $tdfree=$tpl->table_tdfree();    $catz=new mysql_catz();    $sqlA="SELECT statscom_days.username,statscom_days.ipaddr,statscom_days.mac,SUM(statscom_days.hits) as hits,SUM(statscom_days.size) as size FROM statscom_days,statscom_websites WHERE statscom_days.siteid=statscom_websites.siteid AND statscom_websites.category=$category_id GROUP BY statscom_days.username,statscom_days.ipaddr,statscom_days.mac ORDER BY size DESC";    $sql="SELECT username,ipaddr,mac,SUM(hits) as hits,SUM(size) as size FROM ($sqlA) as t GROUP BY username,ipaddr,mac ORDER BY size DESC LIMIT 500";    $results=$q->QUERY_SQL($sql);    if(!$q->ok){        echo $tpl->div_error($q->mysql_error);    }    while ($ligne = pg_fetch_assoc($results)) {        if ($TRCLASS == "footable-odd ") {            $TRCLASS = null;        } else {            $TRCLASS = "footable-odd ";        }        $u=array();        $hits=$tpl->FormatNumber($ligne["hits"]);        $size=FormatBytes($ligne["size"]/1024);        $username=trim($ligne["username"]);        $mac=$ligne["mac"];        $ipaddr=$ligne["ipaddr"];        if($username<>null){$u[]=$username;}        if($mac<>null){$u[]=$mac;}        if($ipaddr<>null){$u[]=$ipaddr;}        $cname=@implode(", ",$u);        $html[]="<tr style='vertical-align:middle' class='$TRCLASS'>";        $html[]="<td><strong><i class=\"fas fa-user\"></i>&nbsp;$cname</strong></td>";        $html[]="<td $td1>$size</td>";        $html[]="<td $td1>$hits</td>";        $html[]="</tr>";    }    $html[]="</tbody>";    $html[]="<tfoot>";    $html[]="<tr>";    $html[]="<td colspan='8'>";    $html[]="<ul class='pagination pull-right'></ul>";    $html[]="</td>";    $html[]="</tr>";    $html[]="</tfoot>";    $html[]="</table>";    $html[]="</div><script> NoSpinner();\n".@implode("\n",$tpl->ICON_SCRIPTS)."$(document).ready(function() { $('#table-$t').footable({ \"filtering\": { \"enabled\": true }, \"sorting\": { \"enabled\": true },\"paging\": { \"size\": {$GLOBALS["FOOTABLE_PSIZE"]} } } ) }); </script>";    echo $tpl->_ENGINE_parse_body(@implode("\n", $html));}function category_list(){    $tpl=new template_admin();    $page=CurrentPageName();    $q=new postgres_sql();    $t=time();    $TRCLASS=null;    $category_id=$_GET["categories-list"];    $html[]="<div class='row border-bottom white-bg dashboard-header'>";    $html[]="<div id='recategorize-$category_id'></div>";    if($category_id>0) {        $html[] = "<div class=\"btn-group\" data-toggle=\"buttons\">";        $html[] = $tpl->button_label_table("{rescan_database}", "Loadjs('$page?recategorize-js=$category_id')", "fa fa-repeat", "AllowViewStatistics");        $html[] = "</div>";    }    $html[]="</div>";    $html[]="<table id='table-$t' class=\"footable table table-stripped\"     data-page-size=\"100\" data-paging=\"true\">";    $html[]="<thead>";    $html[]="<tr>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{website}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{size}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{hits}</th>";    $html[]="</tr>";    $html[]="</thead>";    $html[]="<tbody>";    $td1=$tpl->table_td1prc_Left();    $tdfree=$tpl->table_tdfree();    $catz=new mysql_catz();    $sql="SELECT siteid,sitename, SUM(hitstot) as hits, SUM(sizetot) as size FROM statscom_websites WHERE category=$category_id GROUP by sitename,siteid ORDER by size DESC";    $results=$q->QUERY_SQL($sql);    if(!$q->ok){echo $tpl->div_error($q->mysql_error);}    while ($ligne = pg_fetch_assoc($results)) {        if ($TRCLASS == "footable-odd ") {            $TRCLASS = null;        } else {            $TRCLASS = "footable-odd ";        }        $siteid=intval($ligne["siteid"]);        $hits=$tpl->FormatNumber($ligne["hits"]);        $size=FormatBytes($ligne["size"]/1024);        $sitename=$ligne["sitename"];        $url="fw.statscom.browse.website.php?siteid=$siteid&total=yes";        $cname=$tpl->td_href($sitename,"$sitename: {statistics}","Loadjs('$url')");        $html[]="<tr style='vertical-align:middle' class='$TRCLASS'>";        $html[]="<td><strong>$cname</strong></td>";        $html[]="<td $td1>$size</td>";        $html[]="<td $td1>$hits</td>";        $html[]="</tr>";    }    $html[]="</tbody>";    $html[]="<tfoot>";    $html[]="<tr>";    $html[]="<td colspan='4'>";    $html[]="<ul class='pagination pull-right'></ul>";    $html[]="</td>";    $html[]="</tr>";    $html[]="</tfoot>";    $html[]="</table>";    $html[]="</div><script> NoSpinner();\n".@implode("\n",$tpl->ICON_SCRIPTS)."$(document).ready(function() { $('#table-$t').footable({ \"filtering\": { \"enabled\": true }, \"sorting\": { \"enabled\": true },\"paging\": { \"size\": {$GLOBALS["FOOTABLE_PSIZE"]} } } ) }); </script>";    echo $tpl->_ENGINE_parse_body(@implode("\n", $html));}function categories_table_build(){    $tpl=new template_admin();    $page=CurrentPageName();    $q=new postgres_sql();    $t=time();    $TRCLASS=null;    $html[]="    <div class='row border-bottom white-bg dashboard-header'><table id='table-$t' class=\"footable table table-stripped\"     data-page-size=\"100\" data-paging=\"true\">";    $html[]="<thead>";    $html[]="<tr>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{category}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{members}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text' nowrap>{ipaddr}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{users}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{size}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{hits}</th>";    $html[]="</tr>";    $html[]="</thead>";    $html[]="<tbody>";    //hitstot	sizetot    if(!isset($_GET["search"])){$_GET["search"]=null;}    $search=$_GET["search"];    if($search<>null){        $search=str_replace("*","%",$search);        $search="WHERE xxx=xxx";    }    $td1=$tpl->table_td1prc_Left();    $tdfree=$tpl->table_tdfree();    $catz=new mysql_catz();    $sql="SELECT category, SUM(hitstot) as hits, SUM(sizetot) as size FROM statscom_websites GROUP by category ORDER by size DESC";    $results=$q->QUERY_SQL($sql);    while ($ligne = pg_fetch_assoc($results)) {        if ($TRCLASS == "footable-odd ") {            $TRCLASS = null;        } else {            $TRCLASS = "footable-odd ";        }        $hits=$tpl->FormatNumber($ligne["hits"]);        $size=FormatBytes($ligne["size"]/1024);        $category_id=$ligne["category"];        $cname=$catz->CategoryIntToStr($category_id);        $member=$tpl->icon_user("Loadjs('$page?members-from-cat-js=$category_id')","AsWebStatisticsAdministrator");        $users=$tpl->icon_group("Loadjs('$page?users-from-cat-js=$category_id')","AsWebStatisticsAdministrator");        $member=$tpl->icon_user("Loadjs('$page?members-from-cat-js=$category_id')","AsWebStatisticsAdministrator");        $ipaddr=$tpl->icon_nic("Loadjs('$page?ipaddr-from-cat-js=$category_id')","AsWebStatisticsAdministrator");        $cname=$tpl->td_href($cname,null,"Loadjs('$page?categories-list-js=$category_id')");        $html[]="<tr style='vertical-align:middle' class='$TRCLASS'>";        $html[]="<td><strong>$cname</strong></td>";        $html[]="<td $td1>$member</td>";        $html[]="<td $td1>$ipaddr</td>";        $html[]="<td $td1>$users</td>";        $html[]="<td $td1>$size</td>";        $html[]="<td $td1>$hits</td>";        $html[]="</tr>";    }    $html[]="</tbody>";    $html[]="<tfoot>";    $html[]="<tr>";    $html[]="<td colspan='8'>";    $html[]="<ul class='pagination pull-right'></ul>";    $html[]="</td>";    $html[]="</tr>";    $html[]="</tfoot>";    $html[]="</table>";    $html[]="</div><script> NoSpinner();\n".@implode("\n",$tpl->ICON_SCRIPTS)."$(document).ready(function() { $('#table-$t').footable({ \"filtering\": { \"enabled\": true }, \"sorting\": { \"enabled\": true },\"paging\": { \"size\": {$GLOBALS["FOOTABLE_PSIZE"]} } } ) }); </script>";    echo $tpl->_ENGINE_parse_body(@implode("\n", $html));}function query_popup(){    $tpl=new template_admin();    $page=CurrentPageName();    $q=new postgres_sql();    if(!$q->CREATE_STATSCOM()) {        echo $tpl->div_error($q->mysql_error);    }    $results=$q->QUERY_SQL("SELECT zdate FROM statscom_days GROUP BY zdate ORDER BY zdate DESC");    if(!$q->ok){echo $tpl->div_error($q->mysql_error);}    $DATES[date("Y-m-d")]=$tpl->time_to_date(time());    $DATES[date("Y-m-d",strtotime( '-1 days' ))]=$tpl->time_to_date(strtotime( '-1 days' ));    while ($ligne = pg_fetch_assoc($results)) {        $time=strtotime($ligne["zdate"]);        $DATES[$ligne["zdate"]]=$tpl->time_to_date($time);    }    $results=$q->QUERY_SQL("SELECT username,ipaddr,mac FROM statscom_users GROUP BY username,ipaddr,mac ORDER BY username,ipaddr,mac");    if(!$q->ok){echo $tpl->div_error($q->mysql_error);}    while ($ligne = pg_fetch_assoc($results)) {        $username=$ligne["username"];        $ipaddr=$ligne["ipaddr"];        $mac=$ligne["mac"];        if($mac<>"00:00:00:00:00:00"){            $ARRAY_MAC[$mac]=$mac;        }        if($username<>null){            $ARRAY_USER[$username]=$username;        }        if($ipaddr<>null){            $ARRAY_IP[$ipaddr]=$ipaddr;        }    }    for($i=0;$i<24;$i++){        $h=$i;        if($i<10){$h="0{$i}";}        $h="$h";        $TIMES[$h]=$h;    }    for($i=0;$i<60;$i++){        $h=$i;        if($i<10){$h="0{$i}";}        $h="$h";        $MINS[$h]=$h;    }    $form[]=$tpl->field_section("{from_date}");    $form[]=$tpl->field_array_hash($DATES,"FROM","nonull:{from_date}",$_SESSION["STATSCOM_DAY"]["FROM"]);    $tb=explode(":",$_SESSION["STATSCOM_DAY"]["FROMH"]);    $form[]=$tpl->field_array_hash($TIMES,"FROM_HOUR","nonull:{from_time}",$tb[0]);    $form[]=$tpl->field_array_hash($MINS,"FROM_MIN","nonull:{minutes}",$tb[1]);    $form[]=$tpl->field_section("{to_date}");    $tb=explode(":",$_SESSION["STATSCOM_DAY"]["TOH"]);    $form[]=$tpl->field_array_hash($DATES,"TO","nonull:{to_date}",$_SESSION["STATSCOM_DAY"]["TO"]);    $form[]=$tpl->field_array_hash($TIMES,"TO_HOUR","nonull:{from_time}",$tb[0]);    $form[]=$tpl->field_array_hash($MINS,"TO_MIN","nonull:{minutes}",$tb[1]);    $form[]=$tpl->field_section("{websites}");    $q=new postgres_sql();    $catz=new mysql_catz();    $results=$q->QUERY_SQL("SELECT category FROM statscom_websites GROUP BY category");    while ($ligne = pg_fetch_assoc($results)) {        $CATEGORIES[$ligne["category"]]=$catz->CategoryIntToStr($ligne["category"]);    }    $form[] = $tpl->field_array_hash($CATEGORIES, "CATEGORY", "{category}", $_SESSION["STATSCOM_DAY"]["CATEGORY"]);    $form[]=$tpl->field_section("{members}");    if(count($ARRAY_USER)>0) {        $form[] = $tpl->field_array_hash($ARRAY_USER, "USER", "{member}", $_SESSION["STATSCOM_DAY"]["USER"]);    }else{        $tpl->field_hidden("USER","");    }    $form[]=$tpl->field_array_hash($ARRAY_IP,"IP","{ipaddr}",$_SESSION["STATSCOM_DAY"]["IP"]);    if(count($ARRAY_MAC)>0) {        $form[] = $tpl->field_array_hash($ARRAY_MAC, "MAC",            "{MAC}", $_SESSION["STATSCOM_DAY"]["MAC"]);    }else{        $tpl->field_hidden("MAC","");    }    if(!isset($_SESSION["STATSCOM_DAY"]["LIMIT"])){$_SESSION["STATSCOM_DAY"]["LIMIT"]=250;}    $form[]=$tpl->field_numeric("SIZE","{size_up_to} (KB)",$_SESSION["STATSCOM_DAY"]["SIZE"]);    $form[]=$tpl->field_numeric("LIMIT","{max_items}",$_SESSION["STATSCOM_DAY"]["LIMIT"]);    echo $tpl->form_outside("{build_query}",$form,null,"{launch}","LoadAjax('stats-com-data','$page?query=yes');","AsWebStatisticsAdministrator",true);}function query_save(){    $tpl=new template_admin();    $tpl->CLEAN_POST();    $_SESSION["STATSCOM_DAY"]["FROM"]=$_POST["FROM"];    $_SESSION["STATSCOM_DAY"]["TO"]=$_POST["TO"];    $_SESSION["STATSCOM_DAY"]["FROMH"]=$_POST["FROM_HOUR"].":".$_POST["FROM_MIN"];    $_SESSION["STATSCOM_DAY"]["TOH"]=$_POST["TO_HOUR"].":".$_POST["TO_MIN"];    $_SESSION["STATSCOM_DAY"]["USER"]=$_POST["USER"];    $_SESSION["STATSCOM_DAY"]["IP"]=$_POST["IP"];    $_SESSION["STATSCOM_DAY"]["MAC"]=$_POST["MAC"];    $_SESSION["STATSCOM_DAY"]["SIZE"]=$_POST["SIZE"];    $_SESSION["STATSCOM_DAY"]["LIMIT"]=$_POST["LIMIT"];    $_SESSION["STATSCOM_DAY"]["CATEGORY"]=$_POST["CATEGORY"];}function tabs(){    $page=CurrentPageName();    $tpl=new template_admin();    $array["{categories}"]="$page?categories=yes";    $array["{members}"]="$page?members-form=yes";    $array["{familysite}"]="$page?sites-form=yes";    echo "<div style='margin-top:10px'>";    echo $tpl->tabs_default($array);    echo "</div>";}function page(){    $tpl=new template_admin();    $page=CurrentPageName();    $html[]="<div class=\"btn-group\" data-toggle=\"buttons\" style='margin-top: 10px'>";    $html[]=$tpl->button_label_table("{build_query}",            "Loadjs('$page?query-js=yes')", "fas fa-filter","AsWebStatisticsAdministrator");    $html[]=$tpl->button_label_table("{refresh}",        "LoadAjax('stats-com-data','$page?query=yes')", "fas fa-sync-alt","AsWebStatisticsAdministrator");    $html[]="</div>";    $html[]="<div id='stats-com-data' ></div>";    $html[]="<script>LoadAjax('stats-com-data','$page?query=yes');</script>";    echo $tpl->_ENGINE_parse_body($html);}function query(){    $tpl=new template_admin();    $catz=new mysql_catz();    $q=new postgres_sql();    $t=time();    $TRCLASS=null;$WHEREU=null;$WHEREM=null;$WHEREI=null;$WHERES=null;    //86340 = 24H    // 172740  =    if(!isset($_SESSION["STATSCOM_DAY"]["FROM"])){        $_SESSION["STATSCOM_DAY"]["FROM"]=date("Y-m-d");    }    if(!isset($_SESSION["STATSCOM_DAY"]["TO"])){        $_SESSION["STATSCOM_DAY"]["TO"]=date("Y-m-d");    }    if(!isset($_SESSION["STATSCOM_DAY"]["FROMH"])){        $_SESSION["STATSCOM_DAY"]["FROMH"]="00:00";    }    if(!isset($_SESSION["STATSCOM_DAY"]["TOH"])){        $_SESSION["STATSCOM_DAY"]["TOH"]="23:59";    }    if(!isset($_SESSION["STATSCOM_DAY"]["LIMIT"])){        $_SESSION["STATSCOM_DAY"]["LIMIT"]="250";    }    if(intval($_SESSION["STATSCOM_DAY"]["LIMIT"])==0){        $_SESSION["STATSCOM_DAY"]["LIMIT"]=250;    }    $time1=strtotime( $_SESSION["STATSCOM_DAY"]["FROM"]." ". $_SESSION["STATSCOM_DAY"]["FROMH"]);    $time2=strtotime($_SESSION["STATSCOM_DAY"]["TO"]." ". $_SESSION["STATSCOM_DAY"]["TOH"]);    $seconds=$time2-$time1;    if($seconds<0){       echo  $tpl->div_error("{please_define_dates_in_correct_order}");        return;    }    if($seconds<259150){        $TABLE_SELECTED="statscom";        $date1=$_SESSION["STATSCOM_DAY"]["FROM"]." ". $_SESSION["STATSCOM_DAY"]["FROMH"];        $date2=$_SESSION["STATSCOM_DAY"]["TO"]." ". $_SESSION["STATSCOM_DAY"]["TOH"];        $tt2=date("Y-m-d",strtotime($date2));        $TITLES[]="{from} " .$tpl->time_to_date(strtotime($date1),true);        if($tt2==date("Y-m-d")) {            $TITLES[] = "{to} {today} " . $tpl->time_to_date(strtotime($date2), true);        }else{            $TITLES[] = "{to} " . $tpl->time_to_date(strtotime($date2), true);        }    }else{        $TABLE_SELECTED="statscom_days";        $date1=$_SESSION["STATSCOM_DAY"]["FROM"];        $date2=$_SESSION["STATSCOM_DAY"]["TO"];        $tt2=date("Y-m-d",strtotime($date2));        $TITLES[]="{from} " .$tpl->time_to_date(strtotime($date1),false);        if($tt2==date("Y-m-d")) {            $TITLES[] = "{to} {today} " . $tpl->time_to_date(strtotime($date2), false);        }else{            $TITLES[] = "{to} " . $tpl->time_to_date(strtotime($date2), false);        }    }    $TITLES[]="(".distanceOfTimeInWords(strtotime($date1),strtotime($date2)).")";    if($_SESSION["STATSCOM_DAY"]["USER"]<>null){        $TITLES[]="{and} {member} {$_SESSION["STATSCOM_DAY"]["USER"]}";        $WHEREU=" AND username='{$_SESSION["STATSCOM_DAY"]["USER"]}'";    }    if($_SESSION["STATSCOM_DAY"]["IP"]<>null){        $TITLES[]="{and} {ipaddr} {$_SESSION["STATSCOM_DAY"]["IP"]}";        $WHEREI=" AND ipaddr='{$_SESSION["STATSCOM_DAY"]["IP"]}'";    }    if($_SESSION["STATSCOM_DAY"]["MAC"]<>null){        $TITLES[]="{and} {MAC} {$_SESSION["STATSCOM_DAY"]["MAC"]}";        $WHEREM=" AND mac='{$_SESSION["STATSCOM_DAY"]["MAC"]}'";    }    if( intval($_SESSION["STATSCOM_DAY"]["SIZE"])>0){        $size_q=round(intval( $_SESSION["STATSCOM_DAY"]["SIZE"])*1024);        $WHERES=" $TABLE_SELECTED.size > $size_q AND";    }    if(is_numeric($_SESSION["STATSCOM_DAY"]["CATEGORY"])){        $catz=new mysql_catz();        $TITLES[]="{and} {category} ".$catz->CategoryIntToStr($_SESSION["STATSCOM_DAY"]["CATEGORY"]);        $WEREC=" AND statscom_websites.category={$_SESSION["STATSCOM_DAY"]["CATEGORY"]}";    }    $html[]="<H2 style='margin-top: 10px'>".@implode(" ",$TITLES)."<h3><i class=\"fas fa-file-csv\"></i>&nbsp; <a href='ressources/logs/web/statscom.csv'>statscom.csv</a></h3></H2>";    $sql="SELECT SUM($TABLE_SELECTED.hits) as hits,     SUM($TABLE_SELECTED.size) as size,    $TABLE_SELECTED.username,    $TABLE_SELECTED.ipaddr,    $TABLE_SELECTED.mac,    $TABLE_SELECTED.zdate,    statscom_websites.sitename,    statscom_websites.siteid,    statscom_websites.category       FROM $TABLE_SELECTED,statscom_websites WHERE{$WHERES}    statscom_websites.siteid=$TABLE_SELECTED.siteid AND    $TABLE_SELECTED.zdate >='$date1' AND  $TABLE_SELECTED.zdate <= '$date2'{$WHEREU}{$WHEREI}{$WHEREM}{$WEREC}    GROUP BY $TABLE_SELECTED.zdate,$TABLE_SELECTED.username,$TABLE_SELECTED.ipaddr,$TABLE_SELECTED.mac,statscom_websites.sitename, statscom_websites.siteid,statscom_websites.category ORDER BY $TABLE_SELECTED.zdate    LIMIT {$_SESSION["STATSCOM_DAY"]["LIMIT"]}";    $results=$q->QUERY_SQL($sql);    if(!$q->ok){        echo  $tpl->_ENGINE_parse_body($html);        echo  $tpl->div_error("{$seconds}s<br>".$q->mysql_error."<br>$sql");        return;    }    $csvpath=dirname(__FILE__)."/ressources/logs/web/statscom.csv";    $html[]="    <table id='table-$t' class=\"footable table table-stripped\"     data-page-size=\"100\" data-paging=\"true\">";    $html[]="<thead>";    $html[]="<tr>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{date}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{sitename}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{category}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text' nowrap>{member}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{MAC}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{ipaddr}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{size}</th>";    $html[]="<th data-sortable=true class='text-capitalize' data-type='text'>{hits}</th>";    $html[]="</tr>";    $html[]="</thead>";    $html[]="<tbody>";    $td1=$tpl->table_td1prc_Left();    $tdfree=$tpl->table_tdfree();    $fpcsv = fopen($csvpath, 'w');    fputcsv($fpcsv, array("date", "Site", 'Categoy', 'Member','Mac','IP','Size','Hits'));    while ($ligne = pg_fetch_assoc($results)) {        if ($TRCLASS == "footable-odd ") {            $TRCLASS = null;        } else {            $TRCLASS = "footable-odd ";        }        $hits=$tpl->FormatNumber($ligne["hits"]);        $size=FormatBytes($ligne["size"]/1024);        $date=$ligne["zdate"];        $sitename=$ligne["sitename"];        $category_id=$ligne["category"];        $category=$catz->CategoryIntToStr($category_id);        $ipaddr=$ligne["ipaddr"];        $username=$ligne["username"];        $mac=$ligne["mac"];        $siteid=$ligne["siteid"];        $params=array();        $params[]="username=".urlencode($username);        $params[]="category=".urlencode($category_id);        $params[]="sitename=".urlencode($sitename);        $params[]="mac=".urlencode($mac);        $params[]="ipaddr=".urlencode($ipaddr);        $params[]="date1=".urlencode($date1);        $params[]="date2=".urlencode($date2);        $parm=@implode("&",$params);        fputcsv($fpcsv, array($date, $sitename, $category, $username,$mac,$ipaddr,$ligne["size"],"$hits"));        $macenc=urlencode($mac);        $category=$tpl->td_href($category,"{statistics}","Loadjs('fw.statscom.browse.categories.php?category=$category_id')");        $mac=$tpl->td_href($mac,"{statistics}","Loadjs('fw.statscom.browse.users.php?field=mac&value=$macenc')");        $ipaddr=$tpl->td_href($ipaddr,"{statistics}","Loadjs('fw.statscom.browse.users.php?field=ipaddr&value=$ipaddr')");        $username=$tpl->td_href($username,"{statistics}","Loadjs('fw.statscom.browse.users.php?field=username&value=$username')");        $sitename=$tpl->td_href($sitename,null,"Loadjs('fw.statscom.browse.website.php?siteid=$siteid')");        $html[]="<tr style='vertical-align:middle' class='$TRCLASS'>";        $html[]="<td $td1>$date</td>";        $html[]="<td $tdfree>$sitename</td>";        $html[]="<td $td1>$category</td>";        $html[]="<td $td1>$username</td>";        $html[]="<td $td1>$mac</td>";        $html[]="<td $td1>$ipaddr</td>";        $html[]="<td $td1>$size</td>";        $html[]="<td $td1>$hits</td>";        $html[]="</tr>";    }    fclose($fpcsv);    $html[]="</tbody>";    $html[]="<tfoot>";    $html[]="<tr>";    $html[]="<td colspan='8'>";    $html[]="<ul class='pagination pull-right'></ul>";    $html[]="</td>";    $html[]="</tr>";    $html[]="</tfoot>";    $html[]="</table>";    $html[]="<script> NoSpinner();\n".@implode("\n",$tpl->ICON_SCRIPTS)."$(document).ready(function() { $('#table-$t').footable({ \"filtering\": { \"enabled\": true }, \"sorting\": { \"enabled\": true },\"paging\": { \"size\": {$GLOBALS["FOOTABLE_PSIZE"]} } } ) }); </script>";    echo $tpl->_ENGINE_parse_body(@implode("\n", $html));}